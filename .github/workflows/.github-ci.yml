# yamllint disable
---
#---------------------------------------------------------------------------------------------------
env:
  UBUNTU_TESTS: "1"  # Run integration and unit tests on Ubuntu machines
  TEST_TIMING_OPTION: ""  # Set the option if local test should be timed or not. Default is off.
  PYTHON_PACKAGE_MANAGER: "conda"  # Python package manager to create the python environments
name: github_ci

on: [push]

jobs:
  build:
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
      - uses: mpi4py/setup-mpi@v1
      - name: build
        run: |
          $PYTHON_PACKAGE_MANAGER env create -f environment.yml
          $PYTHON_PACKAGE_MANAGER activate queens
          pip install -e .[develop]
          $PYTHON_PACKAGE_MANAGER env export > pipeline_conda_environment.yml
          $PYTHON_PACKAGE_MANAGER list
      - name: codechecks
        run: |
          $PYTHON_PACKAGE_MANAGER activate queens
          isort --check-only queens tests > track_isort.txt 2>&1
          black --check queens tests > track_black.txt 2>&1
          pylint --rcfile=.pylintrc_ci queens tests | tee track_pylint.txt 2>&1
          pylint queens tests --rcfile=.pylintrc --output-format=json:pylint_warnings.json --fail-under 0
          python .gitlab/pipeline_utils/code_quality_creator.py pylint_warnings.json
          pydocstyle --match-dir='^(?!.*test).*$' queens > track_pydocstyle.txt 2>&1
      - name: tests
        run: |
          $PYTHON_PACKAGE_MANAGER activate queens
          pytest -v -m "unit_tests or integration_tests" --cov --cov-report=term --cov-report=html:html_coverage_report --cov-report=xml:xml_coverage_report.xml $TEST_TIMING_OPTION --color=yes --junitxml=test_junit.xml
