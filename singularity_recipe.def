BootStrap: docker
From: centos:7

%help
This is a singularity container containing CentOS7 and Python 3.8 as well as necessary QUEENS
dependencies (Python packages) to run the latter on a HPC cluster. Central elements are a copy
of the Drivers class and the main_remote.py file. This container version uses the MPI environment
and 3rd library packages of the host! Therefore it assumes that a working executable (e.g. BACI) is
already available on the cluster. The advantage of this layout is that that we are always
up-to-date with the cluster infrastructure and just mount important directories and copy system
variables at runtime.

%files
  pqueens /queens/pqueens
  environment.yml /queens/environment.yml
  requirements.txt /queens/requirements.txt
  setup_remote.py /queens/setup_remote.py

%setup
  mkdir $SINGULARITY_ROOTFS/lnm

%post
yum install -y wget
yum install -y gcc
yum install -y gcc-c++
# Install miniconda 3
if [ ! -d /usr/local/anaconda ]; then
  wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh \
    -O ~/anaconda.sh && \
  bash ~/anaconda.sh -b -p /usr/local/anaconda && \
  rm ~/anaconda.sh
fi
# set anaconda path
export PATH="/usr/local/anaconda/bin:$PATH"
conda update -y conda
# chmod -R +xr /queens
cd /queens
conda env create -f environment.yml -n QUEENS
/usr/local/anaconda/envs/QUEENS/bin/python setup_remote.py develop
mkdir scratch

%runscript
  exec /usr/local/anaconda/envs/QUEENS/bin/python /queens/pqueens/remote_main.py $@
