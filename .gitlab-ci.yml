stages:
  - conda-environment
  - codechecks
  - tests
  - pages

.docker_settings:
  image: continuumio/miniconda3:latest
  services:
    - name: mongo:3.4
      alias: mongodb
  before_script:
    - export PIP_CACHE_DIR="/opt/cache/pip"
    - apt-get update
    - apt-get install gcc -y
    - apt-get install libgl1-mesa-glx -y
    - apt-get install libxt6
    - conda env create -f environment.yml -n queens
    - source activate queens
    - python setup.py develop
  tags:
    - queens-docker

.centos_settings:
  before_script:
    - source activate queens
  tags:
    - queens-local

.full_test_suite_develop:
  stage: tests
  script:
    - pytest -n4
  except:
    refs:
      - master

.full_test_suite_master:
  stage: tests
  script:
    - pytest --cov-report=html:$CI_PROJECT_DIR/html_coverage_report

conda_environment:
  extends:
    - .centos_settings
  stage: conda-environment
  before_script:
    - conda update -n base conda
    - conda env remove -n queens
  script:
    - conda env create -f environment.yml -n queens
    - source activate queens
    - python setup.py develop

codechecks:
  extends:
    - .centos_settings
  stage: codechecks
  script:
    - pylint -j 4 --output-format=parseable pqueens | tee track_pylint.txt
  artifacts:
    name: "$CI_JOB_NAME-$CI_JOB_ID"
    paths:
      - track_pylint.txt
    when: on_failure
    expire_in: 4 weeks

docker_full_test_suite_develop:
  extends:
  - .docker_settings
  - .full_test_suite_develop

centos_full_test_suite_develop:
  extends:
    - .centos_settings
    - .full_test_suite_develop

docker_full_test_suite_master:
  extends:
    - .docker_settings
    - .full_test_suite_master

centos_full_test_suite_master:
  extends:
    - .centos_settings
    - .full_test_suite_master
  after_script:
    - source activate queens
    - sphinx-apidoc -o doc/source pqueens -f -M
    - cd doc
    # "make html" triggers:
    - sphinx-build -b html -d build/doctrees   source build/html
  artifacts:
    name: coverage_report
    paths:
      - html_coverage_report
      - doc/build/html
    when: on_success
    expire_in: 3 days

pages:
  extends:
    - .centos_settings
  stage: pages
  # disable cache on this job since we do not need conda env here
  dependencies:
    - centos_full_test_suite_master
  before_script:
    - pip install anybadge
    - mkdir public
  script:
    - mv html_coverage_report public/coverage_report
    - mv doc/build/html public/docs
    # Create sphinx badge
    - anybadge -l sphinx -v ok --color=green -f public/sphinx-badge.svg

  artifacts:
      # store the public path in artifact
      # this is needed since in a subsequent deploy stage (automatically generated by GitLab)
      # the content of the below artifact is published on GitLab Pages
      paths:
          - public

